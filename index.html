<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonia do Altar</title>
    <link rel="icon" href="H.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #FDFBF8; /* Softer background color */
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Playfair Display', serif;
        }
        .text-gold {
            color: #b69260; /* Updated gold color */
        }
        .bg-gold {
            background-color: #b69260; /* Updated gold color */
        }
        .border-gold {
            border-color: #b69260; /* Updated gold color */
        }
        .hero-bg {
            background-image: linear-gradient(rgba(0, 0, 0, 0.55), rgba(0, 0, 0, 0.55)), url('https://images.pexels.com/photos/169198/pexels-photo-169198.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1');
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
        }
        
        /* Media Cropper for Instagram videos */
        .media-cropper {
            position: relative;
            overflow: hidden;
            padding-top: 100%;
            border-radius: 12px;
            background-color: #e0e0e0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .media-cropper .instagram-media {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            transform: scale(1.25) translateY(-4.5%);
            border: none !important;
            box-shadow: none !important;
            margin: 0 !important;
        }
        
        /* Animations */
        .animated-item {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        .animated-item.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .animated-item.delay-1 { transition-delay: 0.1s; }
        .animated-item.delay-2 { transition-delay: 0.2s; }
        .animated-item.delay-3 { transition-delay: 0.3s; }

        /* Custom checkbox style */
        .custom-checkbox:checked {
            background-color: #b69260; /* Updated gold color */
            border-color: #b69260; /* Updated gold color */
        }
        .custom-checkbox:checked + span {
            color: #b69260; /* Updated gold color */
        }
        
        /* Navlink style */
        .nav-link {
            position: relative;
            color: white;
            text-decoration: none;
            transition: color 0.3s;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #b69260; /* Updated gold color */
            transition: width 0.3s;
        }
        .nav-link:hover {
            color: #b69260; /* Updated gold color */
        }
        .nav-link:hover::after {
            width: 100%;
        }

        section[id] {
            scroll-margin-top: 80px;
        }

        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 90%;
            max-width: 550px; /* Increased width for new fields */
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Scrollbar for Webkit browsers (Chrome, Safari) */
        ::-webkit-scrollbar {
            width: 8px; /* Make it slightly thinner */
        }

        ::-webkit-scrollbar-track {
            background: transparent; /* Changed to transparent to remove the visible track */
        }

        ::-webkit-scrollbar-thumb {
            background: #b69260; /* Updated gold color for the scrollbar thumb */
            border-radius: 10px; /* Keep rounded corners for the thumb */
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a08154; /* Darker gold on hover */
        }

        /* Tab styles */
        .tab-header {
            display: flex;
            justify-content: space-around;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-weight: 600;
            color: #888;
            transition: color 0.3s, border-bottom 0.3s;
            font-size: 0.875rem; /* Smaller font for more tabs */
        }
        .tab-button.active {
            color: #b69260; /* Updated gold color */
            border-bottom: 2px solid #b69260; /* Updated gold color */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="text-gray-800">

    <nav id="navbar" class="fixed top-0 left-0 w-full z-50 transition-all duration-300 py-2">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <a href="#" class="text-white text-2xl font-bold font-playfair flex items-center">
                <img src="H.png" alt="Logo Harmonia do Altar" class="h-10 mr-2 inline-block" onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/b69260?text=H'">armonia do Altar
            </a>
            
            <div class="hidden md:flex space-x-8">
                <a href="#sobre" class="nav-link">Sobre</a>
                <a href="#galeria" class="nav-link">Galeria</a>
                <a href="#planos" class="nav-link">Planos</a>
                <a href="#contato" class="nav-link">Contato</a>
            </div>

            <div class="md:hidden">
                <button id="mobile-menu-button" class="text-white focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-gray-800 bg-opacity-95">
            <a href="#sobre" class="nav-link-mobile block py-3 px-6 text-sm text-white hover:bg-gold transition-colors">Sobre</a>
            <a href="#galeria" class="nav-link-mobile block py-3 px-6 text-sm text-white hover:bg-gold transition-colors">Galeria</a>
            <a href="#planos" class="nav-link-mobile block py-3 px-6 text-sm text-white hover:bg-gold transition-colors">Planos</a>
            <a href="#contato" class="nav-link-mobile block py-3 px-6 text-sm text-white hover:bg-gold transition-colors">Contato</a>
        </div>
    </nav>

    <header class="hero-bg text-white shadow-lg h-screen flex items-center justify-center">
        <div class="text-center">
            <h1 class="text-5xl md:text-7xl font-bold mb-2 animated-item">
                <img src="H.png" alt="Logo Harmonia do Altar" class="h-20 md:h-32 inline-block align-middle mr-4" onerror="this.onerror=null; this.src='https://placehold.co/128x128/ffffff/b69260?text=H'">armonia do Altar
            </h1>
            <p class="text-xl md:text-2xl font-light animated-item delay-1">A Trilha Sonora Perfeita para o Seu Grande Dia</p>
        </div>
    </header>

    <main class="container mx-auto px-6 py-12 md:py-20">
        
        <section id="sobre" class="text-center max-w-4xl mx-auto mb-16 md:mb-24 animated-item">
            <h2 class="text-3xl md:text-4xl font-bold mb-4">Música que Conta a Sua História</h2>
            <div class="w-20 h-1 bg-gold mx-auto mb-6"></div>
            <p class="text-gray-600 leading-relaxed text-lg">
                Para nós, cada casamento é a celebração de uma história de amor única. E toda grande história merece uma trilha sonora inesquecível. Somos o Harmonia do Altar, um grupo de músicos apaixonados por transformar cerimônias em eventos memoráveis. Nosso propósito é ir além da música: queremos tocar o coração de cada convidado e, principalmente, o de vocês, com arranjos que capturam a essência do seu amor e a solenidade do seu grande dia.
            </p>
        </section>
        
        <section id="galeria" class="mb-16 md:mb-24">
            <div class="animated-item">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-4">Sinta a Nossa Harmonia</h2>
                <div class="w-20 h-1 bg-gold mx-auto mb-12"></div>
            </div>
            
            <div class="text-center max-w-3xl mx-auto animated-item">
                <h3 class="text-2xl font-bold text-gold mb-3">A Emoção em Cada Nota</h3>
                <p class="text-gray-600 mb-8">A música tem o poder de evocar sentimentos profundos. Imagine a entrada da noiva ao som de um violino emocionante, ou a troca de alianças embalada por um piano suave e vozes que se entrelaçam. É essa atmosfera que criamos.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <div class="media-cropper animated-item delay-1">
                    <blockquote class="instagram-media" data-instgrm-permalink="https://www.instagram.com/reel/C8YQSOEsv0-/" data-instgrm-version="14"></blockquote>
                </div>
                <div class="media-cropper animated-item delay-2">
                    <blockquote class="instagram-media" data-instgrm-permalink="https://www.instagram.com/reel/C8V3pPAsYSj/" data-instgrm-version="14"></blockquote>
                </div>
            </div>

            <div class="text-center max-w-3xl mx-auto mt-20 animated-item">
                <h3 class="text-2xl font-bold text-gold mb-3">Elegância e Profissionalismo</h3>
                <p class="text-gray-600 mb-8">Acreditamos que a beleza está na harmonia, não só musical, mas também visual. Nossos músicos se apresentam com a sofisticação que a sua cerimônia merece, e nossas performances são um reflexo do nosso compromisso com a excelência.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <div class="media-cropper animated-item delay-1">
                    <blockquote class="instagram-media" data-instgrm-permalink="https://www.instagram.com/p/C8VlkbksuVZ/" data-instgrm-version="14"></blockquote>
                </div>
                <div class="media-cropper animated-item delay-2">
                    <blockquote class="instagram-media" data-instgrm-permalink="https://www.instagram.com/p/CpBIkGaOdrZ/" data-instgrm-version="14"></blockquote>
                </div>
            </div>

            <div class="text-center max-w-3xl mx-auto mt-20 animated-item">
                <h3 class="text-2xl font-bold text-gold mb-3">Alegria e Versatilidade</h3>
                <p class="text-gray-600 mb-8">Seu casamento deve refletir sua personalidade. Do clássico ao popular, do sacro ao contemporâneo, nosso repertório é vasto e adaptável. Celebramos o amor em todos os ritmos, garantindo momentos de pura alegria e emoção.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="media-cropper animated-item delay-1">
                    <blockquote class="instagram-media" data-instgrm-permalink="https://www.instagram.com/reel/C8VkPNDsAit/" data-instgrm-version="14"></blockquote>
                </div>
                <div class="media-cropper animated-item delay-2">
                    <blockquote class="instagram-media" data-instgrm-permalink="https://www.instagram.com/reel/C8YEx9mse1O/" data-instgrm-version="14"></blockquote>
                </div>
            </div>
        </section>

        <section id="planos" class="py-16 md:py-24 bg-white rounded-2xl shadow-sm">
            <div class="text-center max-w-4xl mx-auto mb-12 md:mb-16 animated-item">
                <h2 class="text-3xl md:text-4xl font-bold mb-4">Nossas Configurações Sugeridas</h2>
                <div class="w-20 h-1 bg-gold mx-auto mb-6"></div>
                <p class="text-gray-600 leading-relaxed text-lg mb-8">
                    Nossa formação padrão inclui <strong>3 vozes e teclado</strong>, com a flexibilidade de adicionar outros instrumentos para personalizar sua sonoridade. O deslocamento tem tarifa fixa para <strong>Angélica/Ivinhema (MS) e valor por km para outras localidades (com um valor base).</strong> Taxas de processamento bancário aplicam-se a pagamentos via boleto e cartão (incluindo deslocamentos especiais), não sendo retidas pela Harmonia do Altar. <strong>Pix e dinheiro são isentos de taxas bancárias.</strong>
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 justify-center">
                
                <div class="bg-gray-50 rounded-lg shadow-md overflow-hidden transform hover:-translate-y-2 hover:shadow-xl transition-all duration-300 flex flex-col animated-item">
                    <div class="p-8 flex-grow">
                        <i class="fas fa-music text-gold text-3xl mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Essência Clássica e Sublime</h3>
                        <p class="text-gray-600 mb-6 text-sm">A nossa formação padrão, com as <strong>3 vozes e o teclado</strong>. Perfeita para quem busca a elegância atemporal e a emoção pura.</p>
                        <h4 class="font-bold mb-2 text-sm">Instrumentos:</h4>
                        <ul class="text-gray-700 text-sm space-y-2">
                            <li>• 3 Vozes + Teclado/Piano</li>
                        </ul>
                    </div>
                    <div class="p-6 border-t bg-white flex justify-between items-center">
                        <div class="text-2xl font-bold">R$ 1.400</div>
                        <button onclick="handleContratar('Essência Clássica e Sublime', ['3 Vozes + Teclado/Piano'], 1400)" class="bg-gold text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-300 text-sm">Contratar</button>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg shadow-lg overflow-hidden transform hover:-translate-y-2 hover:shadow-2xl transition-all duration-300 flex flex-col animated-item delay-1 border-2 border-gold relative">
                    <div class="absolute top-0 right-0 bg-gold text-white text-xs font-bold px-3 py-1 rounded-bl-lg">MAIS POPULAR</div>
                    <div class="p-8 flex-grow">
                        <i class="fas fa-guitar text-gold text-3xl mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Harmonia Delicada e Acústica</h3>
                        <p class="text-gray-600 mb-6 text-sm">A formação padrão com o acréscimo do <strong>violão</strong>. O som quente e dedilhado cria uma atmosfera romântica e acolhedora.</p>
                        <h4 class="font-bold mb-2 text-sm">Instrumentos:</h4>
                        <ul class="text-gray-700 text-sm space-y-2">
                            <li>• 3 Vozes + Teclado/Piano</li>
                            <li>• Violão</li>
                        </ul>
                    </div>
                    <div class="p-6 border-t bg-white flex justify-between items-center">
                        <div class="text-2xl font-bold">R$ 1.600</div>
                        <button onclick="handleContratar('Harmonia Delicada e Acústica', ['3 Vozes + Teclado/Piano', 'Violão'], 1600)" class="bg-gold text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-300 text-sm">Contratar</button>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg shadow-md overflow-hidden transform hover:-translate-y-2 hover:shadow-xl transition-all duration-300 flex flex-col animated-item delay-2">
                    <div class="p-8 flex-grow">
                        <i class="fas fa-layer-group text-gold text-3xl mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Sofisticação e Envolvimento</h3>
                        <p class="text-gray-600 mb-6 text-sm">Além da base, o <strong>contrabaixo</strong> adiciona uma sonoridade mais encorpada e um groove sutil, trazendo profundidade e elegância.</p>
                        <h4 class="font-bold mb-2 text-sm">Instrumentos:</h4>
                        <ul class="text-gray-700 text-sm space-y-2">
                            <li>• 3 Vozes + Teclado/Piano</li>
                            <li>• Contrabaixo</li>
                        </ul>
                    </div>
                    <div class="p-6 border-t bg-white flex justify-between items-center">
                        <div class="text-2xl font-bold">R$ 1.600</div>
                        <button onclick="handleContratar('Sofisticação e Envolvimento', ['3 Vozes + Teclado/Piano', 'Contrabaixo'], 1600)" class="bg-gold text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-300 text-sm">Contratar</button>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg shadow-md overflow-hidden transform hover:-translate-y-2 hover:shadow-xl transition-all duration-300 flex flex-col animated-item">
                    <div class="p-8 flex-grow">
                        <i class="fas fa-sliders-h text-gold text-3xl mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Sonoridade Completa e Marcante</h3>
                        <p class="text-gray-600 mb-6 text-sm">Com <strong>contrabaixo e violão</strong> somados à base, esta opção traz uma sonoridade grandiosa, preenchida e com uma textura rica.</p>
                        <h4 class="font-bold mb-2 text-sm">Instrumentos:</h4>
                        <ul class="text-gray-700 text-sm space-y-2">
                            <li>• 3 Vozes + Teclado/Piano</li>
                            <li>• Contrabaixo</li>
                            <li>• Violão</li>
                        </ul>
                    </div>
                    <div class="p-6 border-t bg-white flex justify-between items-center">
                        <div class="text-2xl font-bold">R$ 1.800</div>
                        <button onclick="handleContratar('Sonoridade Completa e Marcante', ['3 Vozes + Teclado/Piano', 'Violão', 'Contrabaixo'], 1800)" class="bg-gold text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-300 text-sm">Contratar</button>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg shadow-md overflow-hidden transform hover:-translate-y-2 hover:shadow-xl transition-all duration-300 flex flex-col animated-item delay-1">
                    <div class="p-8 flex-grow">
                        <i class="fas fa-star text-gold text-3xl mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Versatilidade e Brilho Acústico</h3>
                        <p class="text-gray-600 mb-6 text-sm">A formação mais completa, com <strong>violão, guitarra e contrabaixo</strong>. Permite explorar diferentes estilos com arranjos modernos.</p>
                        <h4 class="font-bold mb-2 text-sm">Instrumentos:</h4>
                        <ul class="text-gray-700 text-sm space-y-2">
                            <li>• 3 Vozes + Teclado/Piano</li>
                            <li>• Violão</li>
                            <li>• Guitarra</li>
                            <li>• Contrabaixo</li>
                        </ul>
                    </div>
                    <div class="p-6 border-t bg-white flex justify-between items-center">
                        <div class="text-2xl font-bold">R$ 2.000</div>
                        <button onclick="handleContratar('Versatilidade e Brilho Acústico', ['3 Vozes + Teclado/Piano', 'Violão', 'Guitarra', 'Contrabaixo'], 2000)" class="bg-gold text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-300 text-sm">Contratar</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="custom-plan-builder" class="bg-white rounded-2xl shadow-sm p-8 md:p-12 text-center mt-16 md:mt-24 animated-item">
            <h2 class="text-3xl md:text-4xl font-bold mb-4">Crie o Seu Plano Personalizado</h2>
            <div class="w-20 h-1 bg-gold mx-auto mb-6"></div>
            <p class="max-w-3xl mx-auto text-gray-600 mb-8">
                Adicione instrumentos à nossa formação padrão para criar a sonoridade perfeita para o seu dia.
            </p>
            <div class="max-w-2xl mx-auto text-left">
                <div class="p-4 bg-gray-100 rounded-lg mb-4 flex justify-between items-center">
                    <span class="font-bold text-gray-700">Formação Padrão (3 Vozes + Teclado)</span>
                    <span class="font-bold text-gray-700">R$ 1.400,00</span>
                </div>
                <h4 class="text-lg font-bold text-gray-800 mt-6 mb-3">Instrumentos da Banda:</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="band-instrument-options"></div>
                
                <h4 class="text-lg font-bold text-gray-800 mt-8 mb-2">Músicos Convidados: <span class="text-sm font-normal text-gray-600">(Um toque de brilho)</span></h4>
                <p class="text-sm text-gray-600 mb-4">Para uma sonoridade ainda mais especial, adicione o romantismo do violino ou a sofisticação do saxofone.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="guest-instrument-options"></div>
            </div>

            <div class="mt-8 max-w-2xl mx-auto border-t pt-6">
                <button id="contract-btn-custom" class="mt-6 w-full bg-gold text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-300 transform hover:scale-105">Contratar Plano Personalizado</button>
            </div>
        </section>

    </main>

    <footer id="contato" class="bg-gray-800 text-white mt-12 md:mt-20">
        <div class="container mx-auto px-6 py-12 text-center animated-item">
            <h2 class="text-3xl font-bold mb-4">Vamos Conversar?</h2>
            <p class="max-w-3xl mx-auto mb-6 text-gray-300">
                Estamos aqui para tirar todas as dúvidas e garantir que cada nota no seu grande dia seja exatamente como vocês sonham.
            </p>
            <a href="https://wa.me/5567996884226?text=Olá!%20Vi%20o%20site%20do%20Harmonia%20do%20Altar%20e%20gostaria%20de%20um%20orçamento." target="_blank" rel="noopener noreferrer" class="bg-green-500 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-green-600 transition-colors duration-300 transform hover:scale-105 inline-block">
                <i class="fab fa-whatsapp mr-2"></i> Chamar no WhatsApp
            </a>
            <div class="flex justify-center space-x-6 mt-8">
                <a href="https://www.instagram.com/harmoniadoaltar?utm_source=qr&igsh=cXF5dGJ6cTFobmVr" target="_blank" rel="noopener noreferrer" aria-label="Instagram" class="text-gray-400 hover:text-white transition-colors duration-300">
                    <i class="fab fa-instagram text-2xl"></i>
                </a>
                <a href="https://www.facebook.com/share/1CBb9XQqiD/" target="_blank" rel="noopener noreferrer" aria-label="Facebook" class="text-gray-400 hover:text-white transition-colors duration-300">
                    <i class="fab fa-facebook text-2xl"></i>
                </a>
            </div>
        </div>
    </footer>

    <!-- Main Contract Modal (Unified with Tabs) -->
    <div id="main-contract-modal" class="modal fixed inset-0 flex items-center justify-center">
        <div class="modal-content w-full max-w-2xl">
            <span class="close-button" id="close-main-modal-button">&times;</span>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Contratação do Plano</h3>

            <div class="tab-header" role="tablist">
                <button class="tab-button active" data-tab="deslocamento-tab" role="tab">Deslocamento</button>
                <button class="tab-button" data-tab="event-details-tab" role="tab">Detalhes do Evento</button>
                <button class="tab-button" data-tab="payment-method-tab" role="tab">Pagamento</button>
                <button class="tab-button" data-tab="summary-tab" role="tab">Resumo</button>
            </div>

            <!-- TAB 1: DESLOCAMENTO -->
            <div id="deslocamento-tab" class="tab-content active">
                <h4 class="text-xl font-bold text-gray-800 mb-4">Cálculo de Deslocamento</h4>
                <p class="text-gray-600 mb-4">Informe o endereço do local da cerimônia para calcular o custo do deslocamento. <strong>Condições especiais se aplicam para Angélica, MS e Ivinhema, MS.</strong></p>
                <label for="modal-destination-address" class="block text-gray-700 text-sm font-bold mb-2">Endereço Completo (Rua, Número, Cidade, Estado):</label>
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="modal-destination-address" placeholder="Ex: Av. Brasil, 123, Ivinhema, MS" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-gold">
                    <button type="button" id="open-map-selection-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition-colors duration-300 text-sm flex-shrink-0">
                        <i class="fas fa-map-marker-alt mr-1"></i> Abrir Mapa
                    </button>
                </div>
                <p id="modal-deslocamento-error" class="text-red-500 mt-2 hidden text-sm">Por favor, digite um endereço válido.</p>
                <div id="modal-deslocamento-results" class="mt-6 p-4 bg-gray-100 rounded-lg hidden">
                    <p class="text-gray-700">Distância: <span id="modal-distance-display" class="font-bold"></span></p>
                    <p class="text-gray-700">Valor do Deslocamento: <span id="modal-calculated-deslocamento-display" class="font-bold text-gold"></span></p>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="next-to-event-details-btn" class="bg-gold text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-300">Próximo</button>
                </div>
            </div>

            <!-- TAB 2: DETALHES DO EVENTO (NOVO) -->
            <div id="event-details-tab" class="tab-content">
                <h4 class="text-xl font-bold text-gray-800 mb-4">Detalhes da Cerimônia</h4>
                <p class="text-gray-600 mb-4">Por favor, preencha a data e o horário da sua cerimônia.</p>
                
                <div class="mb-4">
                    <label for="ceremony-date" class="block text-gray-700 text-sm font-bold mb-2">Data da Cerimônia:</label>
                    <input type="date" id="ceremony-date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-gold">
                </div>
                
                <div class="mb-4">
                    <label for="ceremony-time" class="block text-gray-700 text-sm font-bold mb-2">Horário da Cerimônia:</label>
                    <input type="time" id="ceremony-time" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-gold">
                </div>

                <!-- Novo campo para Local de Referência -->
                <div class="mb-4">
                    <label for="reference-location" class="block text-gray-700 text-sm font-bold mb-2">Local de Referência (Opcional):</label>
                    <input type="text" id="reference-location" placeholder="Ex: Próximo à praça central" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-gold">
                </div>

                <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                    <p class="text-sm text-gray-700"><strong>Endereço Confirmado:</strong> <span id="confirmed-address-display"></span></p>
                </div>
                <p id="modal-event-details-error" class="text-red-500 mt-2 hidden text-sm">Por favor, preencha a data e o horário.</p>

                <div class="flex justify-between mt-6">
                    <button class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-300" data-navigate-tab="deslocamento-tab">Voltar</button>
                    <button id="next-to-payment-method-btn" class="bg-gold text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-300">Próximo</button>
                </div>
            </div>

            <!-- TAB 3: FORMA DE PAGAMENTO -->
            <div id="payment-method-tab" class="tab-content">
                <h4 class="text-xl font-bold text-gray-800 mb-4">Forma de Pagamento</h4>
                <div class="mb-4 text-gray-700">
                    <p>Valor do Plano: <span id="modal-plan-price" class="font-bold text-gold">R$ 0,00</span></p>
                    <p>Valor do Deslocamento: <span id="modal-freight-price" class="font-bold text-gold">R$ 0,00</span></p>
                    <p>Valor Total (Plano + Deslocamento): <span id="modal-total-price" class="font-bold text-gold">R$ 0,00</span></p>
                    <p class="mt-2 text-lg font-bold">Valor Total a Pagar<span id="fees-suffix" class="text-sm font-normal text-gray-600"> (com taxas)</span>: <span id="modal-total-price-with-fees" class="font-bold text-gold">R$ 0,00</span></p>
                </div>
                <div class="mb-6">
                    <div class="space-y-2">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="payment-method" value="pix" class="form-radio h-4 w-4 text-gold" checked>
                            <span>Pix</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="payment-method" value="dinheiro" class="form-radio h-4 w-4 text-gold">
                            <span>Dinheiro (a verificar com o contratado)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="payment-method" value="boleto" class="form-radio h-4 w-4 text-gold">
                            <span>Boleto (parcelamento em até 5x)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="payment-method" value="cartao" class="form-radio h-4 w-4 text-gold">
                            <span>Cartão de Crédito (parcelamento em até 12x)</span>
                        </label>
                    </div>
                </div>

                <div id="installment-options" class="mb-6 hidden">
                    <label for="installments" class="block text-gray-700 text-sm font-bold mb-2">Número de Parcelas:</label>
                    <select id="installments" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-gold"></select>
                    <p class="mt-2 text-gray-700">Valor por parcela: <span id="installment-value" class="font-bold text-gold">R$ 0,00</span></p>
                </div>

                <div id="boleto-due-date-options" class="mb-6 hidden">
                    <label for="boleto-due-date" class="block text-gray-700 text-sm font-bold mb-2">Melhor dia para vencimento do boleto:</label>
                    <select id="boleto-due-date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-gold">
                        <option value="5">Dia 5</option>
                        <option value="10">Dia 10</option>
                        <option value="15">Dia 15</option>
                        <option value="20">Dia 20</option>
                        <option value="25">Dia 25</option>
                    </select>
                    <p id="modal-boleto-date-error" class="text-red-500 mt-2 hidden text-sm">A data da última parcela não pode ser posterior à data da cerimônia. Por favor, ajuste as parcelas ou a data de vencimento.</p>
                </div>

                <div class="flex justify-between mt-6">
                    <button class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-300" data-navigate-tab="event-details-tab">Voltar</button>
                    <button id="next-to-summary-btn" class="bg-gold text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-300">Próximo</button>
                </div>
            </div>

            <!-- TAB 4: RESUMO E CONTRATAR -->
            <div id="summary-tab" class="tab-content">
                <h4 class="text-xl font-bold text-gray-800 mb-4">Resumo do Orçamento</h4>
                <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                    <p class="text-gray-600"><strong>Plano:</strong> <span id="summary-plan-name" class="font-bold text-gray-800"></span></p>
                    <p class="text-gray-600"><strong>Data do Evento:</strong> <span id="summary-event-date" class="font-bold text-gray-800"></span></p>
                    <p class="text-gray-600"><strong>Endereço:</strong> <span id="summary-event-address" class="font-bold text-gray-800"></span></p>
                    <p class="text-gray-600" id="summary-reference-location-display"><strong>Local de Referência:</strong> <span id="summary-reference-location" class="font-bold text-gray-800"></span></p>
                    <hr class="my-2">
                    <p class="text-gray-600">Valor do Plano: <span id="summary-plan-price" class="font-bold text-gold">R$ 0,00</span></p>
                    <p class="text-gray-600">Valor do Deslocamento: <span id="summary-deslocamento-price" class="font-bold text-gold">R$ 0,00</span></p>
                    <p class="text-gray-600">Valor Total (Plano + Deslocamento): <span id="summary-total-price" class="font-bold text-gold">R$ 0,00</span></p>
                    <p class="text-gray-600" id="summary-total-with-fees-label-container">Valor Total a Pagar<span id="summary-fees-suffix"> (com taxas)</span>: <span id="summary-total-price-with-fees" class="font-bold text-gold">R$ 0,00</span></p>
                    <p class="text-gray-600">Forma de Pagamento: <span id="summary-payment-method" class="font-bold text-gold"></span></p>
                    <p class="text-gray-600" id="summary-installment-details">Parcelamento: <span id="summary-installments" class="font-bold text-gold"></span></p>
                    <p class="text-gray-600 hidden" id="summary-boleto-due-date-details">Vencimento do Boleto: <span id="summary-boleto-due-date" class="font-bold text-gold"></span></p>
                </div>
                
                <div id="fees-explanation" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg text-sm mt-6 hidden">
                    <p class="font-semibold mb-2">Informações sobre Taxas:</p>
                    <p>As taxas aplicadas em pagamentos via Boleto e Cartão de Crédito são referentes aos custos de processamento das operadoras financeiras e bancos. A Harmonia do Altar não retém qualquer valor sobre estas taxas, que são integralmente destinadas à viabilização do parcelamento e segurança da transação. Para pagamentos via Pix ou Dinheiro, não há incidência de taxas adicionais.</p>
                </div>

                <div class="flex justify-between mt-6">
                    <button class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-300" data-navigate-tab="payment-method-tab">Voltar</button>
                    <button id="confirm-contract-btn" class="bg-gold text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-300 transform hover:scale-105">Confirmar Contratação</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Selection Modal -->
    <div id="map-selection-modal" class="modal fixed inset-0 flex items-center justify-center">
        <div class="modal-content w-full max-w-xl h-3/4 flex flex-col">
            <span class="close-button" id="close-map-modal-button">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Selecione a Localização no Mapa</h3>
            <div id="map-canvas" class="flex-grow rounded-lg mb-4" style="height: 400px; width: 100%;"></div>
            <button id="confirm-map-location-btn" class="bg-gold text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-300 mt-4">Confirmar Localização</button>
        </div>
    </div>

    <!-- Boleto Notification Modal -->
    <div id="boleto-notification-modal" class="modal fixed inset-0 flex items-center justify-center">
        <div class="modal-content w-full max-w-md">
            <span class="close-button" id="close-boleto-modal-button">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Atenção sobre o Pagamento via Boleto</h3>
            <p class="text-gray-700 leading-relaxed">
                Informamos que o boleto referente à sua contratação pode ser gerado e pago a qualquer momento antes da data da cerimônia. É fundamental que o pagamento seja efetuado até a data de vencimento. Boletos não pagos após o vencimento estão sujeitos a protesto em cartório, o que pode acarretar restrições de crédito. Para evitar inconvenientes, recomendamos a quitação dentro do prazo estabelecido.
            </p>
            <div class="flex justify-end mt-6">
                <button id="ok-boleto-modal-button" class="bg-gold text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-300">Entendi</button>
            </div>
        </div>
    </div>

    <script async src="//www.instagram.com/embed.js"></script>
    
    <!-- Google Maps API with Places library -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDoL-Za52C0cbwOen71nbKqDpLKgBufd0Y&libraries=geometry,places&callback=initMap"></script>

    <script>
        // --- GLOBAL VARIABLES & CONSTANTS ---
        let mapsInitialized = false;
        let autocomplete;
        let currentPlanDetails = null;
        let currentFinalTotalPrice = 0;
        let currentPlanOnlyPrice = 0;
        let currentDeslocamentoCost = 0;
        let selectedPaymentMethod = 'pix';
        let selectedInstallments = 1;
        let ceremonyDate = null;
        let ceremonyTime = null;
        let selectedBoletoDueDate = 5;
        let debounceTimer;
        const whatsappNumber = '5567996884226'; // Moved to global scope

        // Google Maps related variables
        let selectedPlaceDetails = {
            address: '',
            lat: null,
            lng: null,
            googleMapsUrl: ''
        };
        let map = null;
        let marker = null;
        let geocoder = null;
        let referenceLocation = ''; // New variable for reference location

        // DOM Element variables declared globally
        let modalDestinationAddressInput, modalDeslocamentoError, modalDeslocamentoResultsDiv, modalDistanceDisplay, modalCalculatedDeslocamentoDisplay;
        let referenceLocationInput; // New DOM element variable

        const BASE_PLAN_PRICE = 1400;
        const BOLETO_PER_INSTALLMENT_FEE = 18;
        const FIXED_DESLOCAMENTO_AMOUNT = 70;
        const PER_KM_DESLOCAMENTO_RATE = 1.80 * 2;
        const originAddress = "Angélica, MS, Brazil";

        const INSTRUMENT_PRICES = {
            'Violão': 200, 'Contrabaixo': 200, 'Guitarra': 200,
            'Saxofone': 500, 'Violino': 500, '3 Vozes + Teclado/Piano': BASE_PLAN_PRICE
        };
        const CREDIT_CARD_TOTAL_PERCENTAGES = {
            1: 0.04980, 2: 0.04590 + 0.0531, 3: 0.05970 + 0.0531, 4: 0.07330 + 0.0531,
            5: 0.08660 + 0.0531, 6: 0.09960 + 0.0531, 7: 0.11240 + 0.0531, 8: 0.12500 + 0.0531,
            9: 0.13730 + 0.0531, 10: 0.14930 + 0.0531, 11: 0.16120 + 0.0531, 12: 0.17280 + 0.0531
        };

        // --- GLOBAL FUNCTIONS ---
        function formatCurrency(value) {
            if (typeof value !== 'number' || isNaN(value)) return 'R$ 0,00';
            return `R$ ${value.toFixed(2).replace('.', ',')}`;
        }

        /**
         * Calculates the displacement cost based on destination.
         * Can accept either a formatted address string or latitude/longitude coordinates.
         * @param {string|number} destinationOrLat - The destination address string or latitude.
         * @param {number|null} [destinationLng=null] - The longitude, if latitude is provided.
         * @param {function} [callback] - Optional callback function to execute after calculation.
         */
        function calculateDeslocamentoInModal(destinationOrLat, destinationLng = null, callback) {
            if (!mapsInitialized) {
                console.error("Google Maps API ainda não carregada.");
                if(modalDeslocamentoError) {
                    modalDeslocamentoError.textContent = "Erro ao carregar o serviço de mapas. Tente novamente.";
                    modalDeslocamentoError.classList.remove('hidden');
                }
                currentDeslocamentoCost = 0;
                currentFinalTotalPrice = currentPlanOnlyPrice;
                if (callback) callback();
                return;
            }

            const service = new google.maps.DistanceMatrixService();
            let destinationsArray;

            if (destinationLng !== null) { // If lat/lng are provided
                destinationsArray = [new google.maps.LatLng(destinationOrLat, destinationLng)];
            } else { // If address string is provided
                destinationsArray = [destinationOrLat];
            }

            service.getDistanceMatrix({
                origins: [originAddress],
                destinations: destinationsArray,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
            }, (response, status) => {
                if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                    const element = response.rows[0].elements[0];
                    const distanceInMeters = element.distance.value;
                    const destinationFormattedAddress = response.destinationAddresses[0];
                    const normalizedDestination = destinationFormattedAddress.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    
                    let isFixedCity = (normalizedDestination.includes('angelica') && normalizedDestination.includes('ms')) || (normalizedDestination.includes('ivinhema') && normalizedDestination.includes('ms'));

                    if (isFixedCity) {
                        currentDeslocamentoCost = FIXED_DESLOCAMENTO_AMOUNT;
                        modalDistanceDisplay.textContent = `Taxa Fixa`;
                    } else {
                        const distanceInKm = distanceInMeters / 1000;
                        currentDeslocamentoCost = FIXED_DESLOCAMENTO_AMOUNT + (distanceInKm * PER_KM_DESLOCAMENTO_RATE);
                        modalDistanceDisplay.textContent = `${distanceInKm.toFixed(2)} km`;
                    }
                    currentFinalTotalPrice = currentPlanOnlyPrice + currentDeslocamentoCost;
                    modalCalculatedDeslocamentoDisplay.textContent = formatCurrency(currentDeslocamentoCost);
                    modalDeslocamentoResultsDiv.classList.remove('hidden');
                    modalDeslocamentoError.classList.add('hidden');
                } else {
                    modalDeslocamentoError.textContent = "Não foi possível calcular o deslocamento para o endereço fornecido.";
                    modalDeslocamentoError.classList.remove('hidden');
                    modalDeslocamentoResultsDiv.classList.add('hidden');
                    currentDeslocamentoCost = 0;
                    currentFinalTotalPrice = currentPlanOnlyPrice;
                }
                if (callback) callback();
            });
        }

        /**
         * Initializes the Google Maps API and Places Autocomplete.
         */
        function initMap() {
            mapsInitialized = true;
            console.log("Google Maps API carregada.");
            geocoder = new google.maps.Geocoder(); // Initialize geocoder for reverse geocoding
            const input = document.getElementById('modal-destination-address');
            if (input) {
                autocomplete = new google.maps.places.Autocomplete(input, { types: ['address'], componentRestrictions: { country: 'br' } });
                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (place.formatted_address && place.geometry && place.geometry.location) {
                        selectedPlaceDetails.address = place.formatted_address;
                        selectedPlaceDetails.lat = place.geometry.location.lat();
                        selectedPlaceDetails.lng = place.geometry.location.lng();
                        selectedPlaceDetails.googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${selectedPlaceDetails.lat},${selectedPlaceDetails.lng}`;
                        calculateDeslocamentoInModal(selectedPlaceDetails.lat, selectedPlaceDetails.lng); // Pass lat/lng for precise calculation
                    } else {
                        // If autocomplete doesn't provide full details, clear selectedPlaceDetails and use raw input
                        selectedPlaceDetails.address = input.value;
                        selectedPlaceDetails.lat = null;
                        selectedPlaceDetails.lng = null;
                        selectedPlaceDetails.googleMapsUrl = '';
                        calculateDeslocamentoInModal(input.value); // Fallback to address string
                    }
                });
            }
        }

        /**
         * Opens the map selection modal and initializes/updates the map.
         */
        function openMapSelectionModal() {
            const mapSelectionModal = document.getElementById('map-selection-modal');
            mapSelectionModal.style.display = 'flex';

            if (!map) {
                // Initialize map only once when the modal is opened for the first time
                const mapCanvas = document.getElementById('map-canvas');
                map = new google.maps.Map(mapCanvas, {
                    center: { lat: -14.235, lng: -51.925 }, // Center of Brazil
                    zoom: 4,
                    fullscreenControl: false, 
                    mapTypeControl: false, 
                    streetViewControl: false, 
                    zoomControl: true, 
                });

                marker = new google.maps.Marker({
                    map: map,
                    draggable: true,
                    animation: google.maps.Animation.DROP,
                });

                // Listen for map clicks to place the marker
                map.addListener('click', (e) => {
                    placeMarkerAndPanTo(e.latLng, map);
                });

                // Listen for marker drag end to update location
                marker.addListener('dragend', () => {
                    placeMarkerAndPanTo(marker.getPosition(), map);
                });
            }

            // Attempt to set initial map center based on current address input or previous selection
            const currentAddress = modalDestinationAddressInput.value.trim();
            if (currentAddress && geocoder) {
                geocoder.geocode({ 'address': currentAddress }, (results, status) => {
                    if (status === 'OK' && results[0] && results[0].geometry && results[0].geometry.location) {
                        map.setCenter(results[0].geometry.location);
                        map.setZoom(15); // Zoom in on the specific address
                        placeMarkerAndPanTo(results[0].geometry.location, map);
                    } else {
                        // Fallback to default center if geocoding fails or no address
                        map.setCenter({ lat: -14.235, lng: -51.925 });
                        map.setZoom(4);
                        marker.setMap(null); // Hide marker if no specific address to center on
                    }
                });
            } else if (selectedPlaceDetails.lat && selectedPlaceDetails.lng) {
                // If a location was previously selected from map, center on it
                map.setCenter({ lat: selectedPlaceDetails.lat, lng: selectedPlaceDetails.lng });
                map.setZoom(15);
                placeMarkerAndPanTo(new google.maps.LatLng(selectedPlaceDetails.lat, selectedPlaceDetails.lng), map);
            } else {
                // Default center if no address or previous selection
                map.setCenter({ lat: -14.235, lng: -51.925 });
                map.setZoom(4);
                marker.setMap(null); // Hide marker initially
            }

            // This ensures the map resizes correctly if the modal was hidden
            google.maps.event.trigger(map, 'resize');
        }

        /**
         * Places a marker on the map and pans to its location, then reverse geocodes the address.
         * @param {google.maps.LatLng} latLng - The latitude and longitude to place the marker.
         * @param {google.maps.Map} mapInstance - The map instance.
         */
        function placeMarkerAndPanTo(latLng, mapInstance) {
            marker.setPosition(latLng);
            marker.setMap(mapInstance); // Ensure marker is visible
            mapInstance.panTo(latLng);

            // Reverse geocode to get the human-readable address
            geocoder.geocode({ 'location': latLng }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    selectedPlaceDetails.address = results[0].formatted_address;
                    selectedPlaceDetails.lat = latLng.lat();
                    selectedPlaceDetails.lng = latLng.lng();
                    selectedPlaceDetails.googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${selectedPlaceDetails.lat},${selectedPlaceDetails.lng}`;
                } else {
                    selectedPlaceDetails.address = `Coordenadas: ${latLng.lat().toFixed(4)}, ${latLng.lng().toFixed(4)}`;
                    selectedPlaceDetails.lat = latLng.lat();
                    selectedPlaceDetails.lng = latLng.lng();
                    selectedPlaceDetails.googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${selectedPlaceDetails.lat},${selectedPlaceDetails.lng}`;
                    console.warn('No address found for selected coordinates, using lat/lng.');
                }
            });
        }

        /**
         * Confirms the location selected on the map and updates the main modal's address input.
         */
        function confirmMapLocation() {
            if (selectedPlaceDetails.lat !== null && selectedPlaceDetails.lng !== null) {
                modalDestinationAddressInput.value = selectedPlaceDetails.address;
                // Trigger the distance calculation based on the precise lat/lng from map
                calculateDeslocamentoInModal(selectedPlaceDetails.lat, selectedPlaceDetails.lng);
            }
            document.getElementById('map-selection-modal').style.display = 'none';
        }

        /**
         * Sends the formatted WhatsApp message with plan details and location.
         * @param {object} plan - Details of the selected plan.
         * @param {string} paymentMethod - Selected payment method.
         * @param {number} installments - Number of installments.
         * @param {number} totalAmountWithFees - Total amount including fees.
         * @param {number} installmentValue - Value per installment.
         */
        function sendWhatsAppMessage(plan, paymentMethod, installments, totalAmountWithFees, installmentValue) {
            // Prefer the address and URL from map selection if available, otherwise fallback to input field
            const destinationAddress = selectedPlaceDetails.address || modalDestinationAddressInput.value;
            const googleMapsLink = selectedPlaceDetails.googleMapsUrl;
            const distanceText = modalDistanceDisplay.textContent;
            const referenceLocationText = referenceLocationInput.value.trim(); // Get reference location text
            
            let message = `*Solicitação de Orçamento - ${plan.type}*\n\n`;
            message += `Olá! Tenho interesse no plano *${plan.name}*.\n\n`;
            message += `*Detalhes do Evento:*\n`;
            const [year, month, day] = ceremonyDate.split('-');
            message += `• *Data:* ${day}/${month}/${year}\n`;
            message += `• *Horário:* ${ceremonyTime}\n`;
            message += `• *Endereço:* ${destinationAddress}\n`;
            if (referenceLocationText) { // Add reference location if available
                message += `• *Local de Referência:* ${referenceLocationText}\n`;
            }
            if (googleMapsLink) {
                message += `• *Localização no Mapa:* ${googleMapsLink}\n\n`; // Add the map link
            } else {
                message += `\n`; // Add a newline even if no map link
            }
            
            message += '*Detalhes do Plano:*\n';
            plan.instruments.forEach(instName => {
                const price = INSTRUMENT_PRICES[instName];
                message += `• ${instName}: ${formatCurrency(price)}\n`;
            });

            message += `\n*Resumo do Orçamento:*\n`;
            message += `• *Valor do Contrato (Plano):* ${formatCurrency(plan.price)}\n`;
            if (currentDeslocamentoCost > 0) {
                message += `• *Valor do Deslocamento:* ${formatCurrency(currentDeslocamentoCost)} (Distância: ${distanceText})\n`;
            }
            if (paymentMethod === 'pix' || paymentMethod === 'dinheiro') {
                message += `• *Valor Total a Pagar:* ${formatCurrency(totalAmountWithFees)}\n`;
            } else {
                message += `• *Valor Total a Pagar (com taxas):* ${formatCurrency(totalAmountWithFees)}\n`;
            }
            
            message += `• *Forma de Pagamento:* ${paymentMethod.charAt(0).toUpperCase() + paymentMethod.slice(1)}\n`;
            message += `• *Parcelamento:* ${installments}x de ${formatCurrency(installmentValue)}\n`;
            if (paymentMethod === 'boleto') {
                message += `• *Vencimento do Boleto:* Todo dia ${selectedBoletoDueDate}\n`;
            }
            if (paymentMethod === 'dinheiro') {
                message += `*(Pagamento a ser verificado com o contratado)*\n`;
            }

            message += '\nGostaria de verificar a disponibilidade e mais detalhes. Obrigado!';
            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/${whatsappNumber}?text=${encodedMessage}`, '_blank');
        }

        // --- SCRIPT EXECUTION ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Assign global DOM elements
                modalDestinationAddressInput = document.getElementById('modal-destination-address');
                modalDeslocamentoError = document.getElementById('modal-deslocamento-error');
                modalDeslocamentoResultsDiv = document.getElementById('modal-deslocamento-results');
                modalDistanceDisplay = document.getElementById('modal-distance-display');
                modalCalculatedDeslocamentoDisplay = document.getElementById('modal-calculated-deslocamento-display');
                referenceLocationInput = document.getElementById('reference-location'); // Assign new DOM element
                
                // const whatsappNumber = '5567996884226'; // Moved to global scope

                // --- MODAL AND ANIMATION SETUP ---
                document.getElementById('main-contract-modal').style.display = 'none';
                document.getElementById('boleto-notification-modal').style.display = 'none';
                document.getElementById('map-selection-modal').style.display = 'none'; // Hide map modal initially

                const animatedItems = document.querySelectorAll('.animated-item');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) entry.target.classList.add('visible');
                    });
                }, { threshold: 0.1 });
                animatedItems.forEach(item => observer.observe(item));

                // --- NAVBAR & MOBILE MENU ---
                const navbar = document.getElementById('navbar');
                const mobileMenuButton = document.getElementById('mobile-menu-button');
                const mobileMenu = document.getElementById('mobile-menu');
                if (navbar && mobileMenuButton && mobileMenu) {
                    window.onscroll = () => navbar.classList.toggle('bg-gray-900', window.scrollY > 50);
                    mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
                    document.querySelectorAll('.nav-link-mobile').forEach(link => {
                        link.addEventListener('click', () => mobileMenu.classList.add('hidden'));
                    });
                }
                
                // --- CUSTOM PLAN BUILDER ---
                const bandInstruments = [
                    { name: 'Violão', price: 200 }, { name: 'Contrabaixo', price: 200 }, { name: 'Guitarra', price: 200 },
                ];
                const guestInstruments = [
                    { name: 'Saxofone', price: 500 }, { name: 'Violino', price: 500 }
                ];
                const bandOptionsContainer = document.getElementById('band-instrument-options');
                const guestOptionsContainer = document.getElementById('guest-instrument-options');
                const contractBtnCustom = document.getElementById('contract-btn-custom');
                const selectedInstruments = new Set();

                function calculateCustomPlanPrice() {
                    let price = BASE_PLAN_PRICE;
                    selectedInstruments.forEach(name => {
                        const instrument = [...bandInstruments, ...guestInstruments].find(i => i.name === name);
                        if (instrument) price += instrument.price;
                    });
                    return price;
                }

                function createCheckbox(instrument, container) {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-3 cursor-pointer p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.dataset.name = instrument.name;
                    checkbox.className = 'form-checkbox h-5 w-5 rounded custom-checkbox focus:ring-gold';
                    const span = document.createElement('span');
                    span.className = 'text-gray-700 transition-colors duration-200';
                    span.textContent = `${instrument.name} (+ ${formatCurrency(instrument.price)})`;
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    container.appendChild(label);
                    checkbox.addEventListener('change', (e) => {
                        e.target.checked ? selectedInstruments.add(e.target.dataset.name) : selectedInstruments.delete(e.target.dataset.name);
                    });
                }

                if(bandOptionsContainer && guestOptionsContainer){
                    bandInstruments.forEach(inst => createCheckbox(inst, bandOptionsContainer));
                    guestInstruments.forEach(inst => createCheckbox(inst, guestOptionsContainer));
                }

                // --- MAIN MODAL LOGIC ---
                const mainContractModal = document.getElementById('main-contract-modal');
                const closeMainModalButton = document.getElementById('close-main-modal-button');
                const tabButtons = document.querySelectorAll('.tab-button');
                const tabContents = document.querySelectorAll('.tab-content');
                let unlockedTabs = ['deslocamento-tab'];

                // --- Element Getters ---
                const ceremonyDateInput = document.getElementById('ceremony-date');
                const ceremonyTimeInput = document.getElementById('ceremony-time');
                const confirmedAddressDisplay = document.getElementById('confirmed-address-display');
                const modalEventDetailsError = document.getElementById('modal-event-details-error');
                const paymentMethodRadios = document.querySelectorAll('input[name="payment-method"]');
                const installmentOptionsDiv = document.getElementById('installment-options');
                const installmentsSelect = document.getElementById('installments');
                const installmentValueEl = document.getElementById('installment-value');
                const boletoDueDateOptionsDiv = document.getElementById('boleto-due-date-options');
                const boletoDueDateSelect = document.getElementById('boleto-due-date');
                const modalBoletoDateError = document.getElementById('modal-boleto-date-error');
                const feesSuffixSpan = document.getElementById('fees-suffix');
                const modalPlanPriceEl = document.getElementById('modal-plan-price');
                const modalFreightPriceEl = document.getElementById('modal-freight-price');
                const modalTotalPriceEl = document.getElementById('modal-total-price');
                const modalTotalPriceWithFeesEl = document.getElementById('modal-total-price-with-fees');
                const summaryPlanNameEl = document.getElementById('summary-plan-name');
                const summaryEventDateEl = document.getElementById('summary-event-date');
                const summaryEventAddressEl = document.getElementById('summary-event-address');
                const summaryReferenceLocationDisplay = document.getElementById('summary-reference-location-display'); // New summary element
                const summaryReferenceLocationEl = document.getElementById('summary-reference-location'); // New summary element
                const summaryPlanPriceEl = document.getElementById('summary-plan-price');
                const summaryDeslocamentoPriceEl = document.getElementById('summary-deslocamento-price');
                const summaryTotalPriceEl = document.getElementById('summary-total-price');
                const summaryTotalWithFeesEl = document.getElementById('summary-total-price-with-fees');
                const summaryPaymentMethodEl = document.getElementById('summary-payment-method');
                const summaryInstallmentDetailsDiv = document.getElementById('summary-installment-details');
                const summaryInstallmentsEl = document.getElementById('summary-installments');
                const summaryBoletoDueDateDetailsDiv = document.getElementById('summary-boleto-due-date-details');
                const summaryBoletoDueDateEl = document.getElementById('summary-boleto-due-date');
                const feesExplanationDiv = document.getElementById('fees-explanation');
                const summaryFeesSuffixSpan = document.getElementById('summary-fees-suffix');

                // --- TAB NAVIGATION ---
                function showTab(tabId) {
                    tabContents.forEach(content => content.style.display = 'none');
                    tabButtons.forEach(button => button.classList.remove('active'));
                    document.getElementById(tabId).style.display = 'block';
                    document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
                    
                    if (tabId === 'event-details-tab') {
                        confirmedAddressDisplay.textContent = modalDestinationAddressInput.value || 'Endereço não informado.';
                    } else if (tabId === 'payment-method-tab') {
                        updatePaymentDetailsDisplay();
                    } else if (tabId === 'summary-tab') {
                        updateSummaryDisplay();
                    }
                }

                function navigateToTab(targetTab) {
                    if (!unlockedTabs.includes(targetTab)) {
                        unlockedTabs.push(targetTab);
                    }
                    showTab(targetTab);
                }

                tabButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const targetTab = e.target.dataset.tab;
                        if (unlockedTabs.includes(targetTab)) {
                            showTab(targetTab);
                        }
                    });
                });
                
                document.querySelectorAll('[data-navigate-tab]').forEach(button => {
                    button.addEventListener('click', (e) => showTab(e.target.dataset.navigateTab));
                });

                document.getElementById('next-to-event-details-btn').addEventListener('click', () => {
                    const address = modalDestinationAddressInput.value.trim();
                    if (!address || modalDeslocamentoResultsDiv.classList.contains('hidden')) {
                        modalDeslocamentoError.textContent = "Por favor, digite um endereço válido e aguarde o cálculo, ou selecione no mapa.";
                        modalDeslocamentoError.classList.remove('hidden');
                        return;
                    }
                    navigateToTab('event-details-tab');
                });

                document.getElementById('next-to-payment-method-btn').addEventListener('click', () => {
                    ceremonyDate = ceremonyDateInput.value;
                    ceremonyTime = ceremonyTimeInput.value;
                    referenceLocation = referenceLocationInput.value.trim(); // Capture reference location
                    if (!ceremonyDate || !ceremonyTime) {
                        modalEventDetailsError.textContent = "Por favor, preencha a data e o horário da cerimônia.";
                        modalEventDetailsError.classList.remove('hidden');
                        return;
                    }
                    modalEventDetailsError.classList.add('hidden');
                    navigateToTab('payment-method-tab');
                });

                document.getElementById('next-to-summary-btn').addEventListener('click', () => {
                    if (validateBoletoDueDate()) {
                        navigateToTab('summary-tab');
                    }
                });

                // --- MODAL OPEN/CLOSE ---
                function showMainContractModal(planPrice, planDetails) {
                    mainContractModal.style.display = 'flex';
                    currentPlanDetails = planDetails;
                    currentPlanOnlyPrice = planPrice;
                    currentDeslocamentoCost = 0;
                    currentFinalTotalPrice = currentPlanOnlyPrice;
                    
                    // Reset fields
                    modalDestinationAddressInput.value = '';
                    ceremonyDateInput.value = '';
                    ceremonyTimeInput.value = '';
                    referenceLocationInput.value = ''; // Reset reference location input
                    selectedPlaceDetails = { address: '', lat: null, lng: null, googleMapsUrl: '' }; // Reset map selection
                    const today = new Date().toISOString().split('T')[0];
                    ceremonyDateInput.setAttribute('min', today);
                    modalDeslocamentoResultsDiv.classList.add('hidden');
                    modalDeslocamentoError.classList.add('hidden');
                    
                    // Reset tabs
                    unlockedTabs = ['deslocamento-tab'];
                    showTab('deslocamento-tab');
                }

                if (closeMainModalButton) {
                    closeMainModalButton.addEventListener('click', () => mainContractModal.style.display = 'none');
                }
                window.addEventListener('click', (event) => {
                    if (event.target == mainContractModal) mainContractModal.style.display = 'none';
                });

                // --- MAP SELECTION MODAL LISTENERS ---
                document.getElementById('open-map-selection-btn').addEventListener('click', openMapSelectionModal);
                document.getElementById('close-map-modal-button').addEventListener('click', () => document.getElementById('map-selection-modal').style.display = 'none');
                document.getElementById('confirm-map-location-btn').addEventListener('click', confirmMapLocation);
                window.addEventListener('click', (event) => {
                    if (event.target == document.getElementById('map-selection-modal')) {
                        document.getElementById('map-selection-modal').style.display = 'none';
                    }
                });

                // --- BOLETO NOTIFICATION MODAL ---
                const boletoNotificationModal = document.getElementById('boleto-notification-modal');
                const closeBoletoModalButton = document.getElementById('close-boleto-modal-button');
                const okBoletoModalButton = document.getElementById('ok-boleto-modal-button');
                if (closeBoletoModalButton) closeBoletoModalButton.addEventListener('click', () => boletoNotificationModal.style.display = 'none');
                if (okBoletoModalButton) okBoletoModalButton.addEventListener('click', () => boletoNotificationModal.style.display = 'none');
                window.addEventListener('click', (event) => {
                    if (event.target == boletoNotificationModal) boletoNotificationModal.style.display = 'none';
                });

                // --- PAYMENT LOGIC ---
                paymentMethodRadios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        selectedPaymentMethod = radio.value;
                        selectedInstallments = 1;
                        updateInstallmentOptions();
                        updatePaymentDetailsDisplay();
                        if (selectedPaymentMethod === 'boleto') {
                            boletoNotificationModal.style.display = 'flex';
                        }
                    });
                });

                installmentsSelect.addEventListener('change', (e) => {
                    selectedInstallments = parseInt(e.target.value);
                    updatePaymentDetailsDisplay();
                });
                
                boletoDueDateSelect.addEventListener('change', (e) => {
                    selectedBoletoDueDate = parseInt(e.target.value);
                    updatePaymentDetailsDisplay();
                });

                function updateInstallmentOptions() {
                    installmentsSelect.innerHTML = '';
                    let maxInstallments = 1;
                    if (selectedPaymentMethod === 'boleto') maxInstallments = 5;
                    else if (selectedPaymentMethod === 'cartao') maxInstallments = 12;

                    for (let i = 1; i <= maxInstallments; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `${i}x`;
                        installmentsSelect.appendChild(option);
                    }
                    installmentsSelect.value = selectedInstallments;
                }

                function updatePaymentDetailsDisplay() {
                    let calculatedTotalForPayment = currentFinalTotalPrice;
                    let finalInstallmentValue = 0;

                    boletoDueDateOptionsDiv.style.display = (selectedPaymentMethod === 'boleto') ? 'block' : 'none';
                    installmentOptionsDiv.style.display = (selectedPaymentMethod === 'boleto' || selectedPaymentMethod === 'cartao') ? 'block' : 'none';
                    feesSuffixSpan.style.display = 'none';

                    if (selectedPaymentMethod === 'boleto') {
                        calculatedTotalForPayment += (BOLETO_PER_INSTALLMENT_FEE * selectedInstallments);
                        feesSuffixSpan.style.display = 'inline';
                    } else if (selectedPaymentMethod === 'cartao') {
                        const percentageFee = CREDIT_CARD_TOTAL_PERCENTAGES[selectedInstallments];
                        if (percentageFee) {
                            calculatedTotalForPayment = currentFinalTotalPrice / (1 - percentageFee);
                        }
                        feesSuffixSpan.style.display = 'inline';
                    }
                    
                    finalInstallmentValue = calculatedTotalForPayment / selectedInstallments;
                    
                    modalPlanPriceEl.textContent = formatCurrency(currentPlanOnlyPrice);
                    modalFreightPriceEl.textContent = formatCurrency(currentDeslocamentoCost);
                    modalTotalPriceEl.textContent = formatCurrency(currentFinalTotalPrice);
                    modalTotalPriceWithFeesEl.textContent = formatCurrency(calculatedTotalForPayment);
                    installmentValueEl.textContent = formatCurrency(finalInstallmentValue);

                    validateBoletoDueDate();
                }
                
                function validateBoletoDueDate() {
                    if (selectedPaymentMethod !== 'boleto' || !ceremonyDate) {
                        modalBoletoDateError.classList.add('hidden');
                        document.getElementById('next-to-summary-btn').disabled = false;
                        return true;
                    }

                    const today = new Date();
                    const ceremony = new Date(ceremonyDate + 'T23:59:59');
                    
                    let firstPaymentDate = new Date(today.getFullYear(), today.getMonth(), selectedBoletoDueDate);
                    if (firstPaymentDate <= today) {
                        firstPaymentDate.setMonth(firstPaymentDate.getMonth() + 1);
                    }

                    let lastPaymentDate = new Date(firstPaymentDate);
                    lastPaymentDate.setMonth(lastPaymentDate.getMonth() + selectedInstallments - 1);

                    if (lastPaymentDate > ceremony) {
                        modalBoletoDateError.classList.remove('hidden');
                        document.getElementById('next-to-summary-btn').disabled = true;
                        return false;
                    } else {
                        modalBoletoDateError.classList.add('hidden');
                        document.getElementById('next-to-summary-btn').disabled = false;
                        return true;
                    }
                }

                // --- SUMMARY LOGIC ---
                function updateSummaryDisplay() {
                    let calculatedTotalForSummary = currentFinalTotalPrice;
                    let finalInstallmentValueForSummary = 0;
                    let paymentMethodText = '';

                    summaryFeesSuffixSpan.style.display = 'none';
                    feesExplanationDiv.classList.add('hidden');
                    summaryBoletoDueDateDetailsDiv.classList.add('hidden');

                    if (selectedPaymentMethod === 'boleto') {
                        calculatedTotalForSummary += (BOLETO_PER_INSTALLMENT_FEE * selectedInstallments);
                        paymentMethodText = 'Boleto';
                        feesExplanationDiv.classList.remove('hidden');
                        summaryFeesSuffixSpan.style.display = 'inline';
                        summaryBoletoDueDateDetailsDiv.classList.remove('hidden');
                        summaryBoletoDueDateEl.textContent = `Todo dia ${selectedBoletoDueDate}`;
                    } else if (selectedPaymentMethod === 'cartao') {
                        const percentageFee = CREDIT_CARD_TOTAL_PERCENTAGES[selectedInstallments];
                        if (percentageFee) calculatedTotalForSummary = currentFinalTotalPrice / (1 - percentageFee);
                        paymentMethodText = 'Cartão de Crédito';
                        feesExplanationDiv.classList.remove('hidden');
                        summaryFeesSuffixSpan.style.display = 'inline';
                    } else if (selectedPaymentMethod === 'pix') {
                        paymentMethodText = 'Pix';
                    } else if (selectedPaymentMethod === 'dinheiro') {
                        paymentMethodText = 'Dinheiro (a verificar com o contratado)';
                    }

                    finalInstallmentValueForSummary = calculatedTotalForSummary / selectedInstallments;

                    summaryPlanNameEl.textContent = currentPlanDetails.name;
                    const [year, month, day] = ceremonyDate.split('-');
                    summaryEventDateEl.textContent = `${day}/${month}/${year} às ${ceremonyTime}`;
                    summaryEventAddressEl.textContent = selectedPlaceDetails.address || modalDestinationAddressInput.value; // Use selected address or input
                    
                    // Update and show/hide reference location in summary
                    if (referenceLocationInput.value.trim()) {
                        summaryReferenceLocationEl.textContent = referenceLocationInput.value.trim();
                        summaryReferenceLocationDisplay.style.display = 'block';
                    } else {
                        summaryReferenceLocationEl.textContent = '';
                        summaryReferenceLocationDisplay.style.display = 'none';
                    }

                    summaryPlanPriceEl.textContent = formatCurrency(currentPlanOnlyPrice);
                    summaryDeslocamentoPriceEl.textContent = formatCurrency(currentDeslocamentoCost);
                    summaryTotalPriceEl.textContent = formatCurrency(currentFinalTotalPrice);
                    summaryTotalWithFeesEl.textContent = formatCurrency(calculatedTotalForSummary);
                    summaryPaymentMethodEl.textContent = paymentMethodText;
                    summaryInstallmentsEl.textContent = `${selectedInstallments}x de ${formatCurrency(finalInstallmentValueForSummary)}`;
                }

                // --- WHATSAPP & HIRING ---
                document.getElementById('confirm-contract-btn').addEventListener('click', () => {
                    const totalAmountWithFees = parseFloat(summaryTotalWithFeesEl.textContent.replace('R$', '').replace(',', '.'));
                    const installmentValuePerInstallment = parseFloat(summaryInstallmentsEl.textContent.split('de ')[1]?.replace('R$', '').replace(',', '.') || totalAmountWithFees);
                    sendWhatsAppMessage(currentPlanDetails, selectedPaymentMethod, selectedInstallments, totalAmountWithFees, installmentValuePerInstallment);
                    mainContractModal.style.display = 'none';
                });

                window.handleContratar = function(planName, instruments, price) {
                    const planDetails = {
                        type: 'Plano Pronto', name: planName, instruments: instruments, price: price
                    };
                    showMainContractModal(price, planDetails);
                };

                if(contractBtnCustom){
                    contractBtnCustom.addEventListener('click', () => {
                        const customPlanPrice = calculateCustomPlanPrice();
                        const planDetails = {
                            type: 'Plano Personalizado', name: 'Plano Personalizado',
                            instruments: ['3 Vozes + Teclado/Piano', ...Array.from(selectedInstruments)],
                            price: customPlanPrice
                        };
                        showMainContractModal(customPlanPrice, planDetails);
                    });
                }

                // --- DESLOCAMENTO CALCULATION ---
                modalDestinationAddressInput.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    const address = modalDestinationAddressInput.value.trim();
                    if (address.length > 3) {
                        debounceTimer = setTimeout(() => {
                            // When typing, use the address string for calculation
                            calculateDeslocamentoInModal(address);
                            // Also try to geocode and store lat/lng for WhatsApp link, but don't force map selection
                            if (geocoder) {
                                geocoder.geocode({ 'address': address }, (results, status) => {
                                    if (status === 'OK' && results[0] && results[0].geometry && results[0].geometry.location) {
                                        selectedPlaceDetails.address = results[0].formatted_address;
                                        selectedPlaceDetails.lat = results[0].geometry.location.lat();
                                        selectedPlaceDetails.lng = results[0].geometry.location.lng();
                                        selectedPlaceDetails.googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${selectedPlaceDetails.lat},${selectedPlaceDetails.lng}`;
                                    } else {
                                        selectedPlaceDetails.lat = null;
                                        selectedPlaceDetails.lng = null;
                                        selectedPlaceDetails.googleMapsUrl = '';
                                    }
                                });
                            }
                        }, 500); // 500ms delay
                    } else {
                        modalDeslocamentoResultsDiv.classList.add('hidden');
                        modalDeslocamentoError.classList.add('hidden');
                        currentDeslocamentoCost = 0;
                        currentFinalTotalPrice = currentPlanOnlyPrice;
                        selectedPlaceDetails = { address: '', lat: null, lng: null, googleMapsUrl: '' }; // Clear map data
                    }
                });
                
                // --- SECURITY (Optional but good practice) ---
                document.addEventListener('contextmenu', event => event.preventDefault());

            } catch (error) {
                console.error("Erro durante o carregamento do script:", error);
            }
        });
    </script>
</body>
</html>
